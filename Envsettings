#! /bin/sh

if test -z "$XCLUSTER_WORKSPACE"; then
	export XCLUSTER_WORKSPACE="$(readlink -f .)/workspace"
	if ! test -d "$XCLUSTER_WORKSPACE"; then
		mkdir -p "$XCLUSTER_WORKSPACE"
		cat <<EOF

The \$XCLUSTER_WORKSPACE is set to;

  XCLUSTER_WORKSPACE=$XCLUSTER_WORKSPACE

EOF
	fi
fi

test -n "$ARCHIVE" || export ARCHIVE=$HOME/Downloads
mkdir -p $ARCHIVE

vm() {
	local bg='#040'
	test "$1" -gt 200 && bg='#400'
	test "$1" -gt 220 && bg='#004'
	XXTERM=XCLUSTER exec xterm -T "vm-$1" -fg wheat -bg "$bg" \
		-e "telnet 192.168.0.$1" &
}

export XCLUSTER="$(readlink -f .)/xcluster.sh"
alias xc=$XCLUSTER

eval $($XCLUSTER env | grep -i DISKIM)
export DISKIM
if test -n "$DISKIM" -a -x "$DISKIM"; then
	alias diskim=$DISKIM
else
	cat <<EOF
"diskim" is missing. Install with;

wget -O - -q \\
 https://github.com/lgekman/diskim/releases/download/$__diskimver/diskim-$__diskimver.tar.xz \\
 | tar -I pxz -C $XCLUSTER_WORKSPACE -xf -

EOF
fi

which mke2fs > /dev/null || export PATH=$PATH:/sbin:/usr/sbin
