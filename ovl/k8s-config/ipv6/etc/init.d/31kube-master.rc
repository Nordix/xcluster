#! /bin/sh

export PATH="/bin:/sbin:/usr/bin:/usr/sbin"

die() {
        echo "$@"
        exit 1
}

hostname | grep -Eq 'vm-[0-9]+$' || die "Invalid hostname [$(hostname)]"
i=$(hostname | cut -d- -f2 | sed -re 's,^0+,,')

test $i -eq 1 || exit 0

. /etc/profile

sleep 1
MASTER_IP=1000::1:192.168.1.1
kube-apiserver --token-auth-file=/srv/kubernetes/known_tokens.csv \
	--allow-privileged=true \
	--insecure-bind-address=$MASTER_IP --advertise-address=$MASTER_IP \
	--authorization-mode=AlwaysAllow \
	--etcd-servers=http://[::1]:2379 --anonymous-auth=false \
	--service-cluster-ip-range=fd00:4000::/112 \
	--enable-admission-plugins=ServiceAccount,AlwaysAdmit \
	--client-ca-file=/srv/kubernetes/ca.crt \
	--tls-private-key-file=/srv/kubernetes/server.key \
	--tls-cert-file=/srv/kubernetes/server.crt \
	> /var/log/kube-apiserver.log 2>&1 &

kube-controller-manager --kubeconfig $KUBECONFIG \
	--allocate-node-cidrs=true --cluster-cidr=1000::2:11.0.0.0/112 \
	--node-cidr-mask-size=120 \
	--controllers="*,serviceaccount,serviceaccount-token" \
	--service-account-private-key-file=/srv/kubernetes/server.key \
	--root-ca-file=/srv/kubernetes/server.crt \
	> /var/log/kube-controller-manager.log 2>&1 &

kube-scheduler --kubeconfig $KUBECONFIG \
	> /var/log/kube-scheduler.log 2>&1 &
